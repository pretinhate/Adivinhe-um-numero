<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adivinhe o N√∫mero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter e estiliza√ß√£o de foco */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        input:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.5); 
        }
        
        body {
            min-height: 100vh;
            margin: 0;
            background-color: #0d1217;
            font-family: 'Inter', sans-serif;
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-bg': '#1f2937', 
                        'accent': '#34d399',      
                        'win': '#10b981',         
                        'lose': '#ef4444',        
                    }
                }
            }
        }
    </script>
</head>
<body class="flex flex-col sm:flex-row items-center justify-center p-4 gap-8">

    <div id="game-container" class="w-full max-w-sm bg-primary-bg p-6 rounded-xl shadow-2xl border border-gray-700 order-2 sm:order-1">
        
        <h1 class="text-3xl font-bold text-white mb-2 text-center">Adivinhe o N√∫mero!</h1>
        <p class="text-gray-400 mb-6 text-center">Tente adivinhar o n√∫mero secreto entre 1 e 100.</p>

        <div id="input-area" class="flex flex-col sm:flex-row gap-3 mb-6">
            <input 
                type="number" 
                id="guessInput" 
                placeholder="Seu palpite (1-100)" 
                min="1" 
                max="100"
                class="flex-grow p-3 text-lg rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400 transition duration-200"
            >
            <button 
                id="checkButton" 
                class="w-full sm:w-auto px-6 py-3 text-lg font-bold text-primary-bg bg-accent hover:bg-win rounded-lg shadow-md transition duration-200 transform hover:scale-105"
            >
                Verificar
            </button>
        </div>

        <div class="space-y-4">
            <div id="message" class="p-4 rounded-lg text-center font-semibold text-lg bg-gray-700 text-gray-300 min-h-[4rem] flex items-center justify-center">
                Digite um n√∫mero e clique em Verificar!
            </div>
            
            <div class="flex justify-between items-center text-gray-400 font-medium">
                <span class="text-lg">Tentativas:</span>
                <span id="attempts" class="text-3xl font-bold text-accent">0</span>
            </div>
        </div>

        <button 
            id="resetButton" 
            class="hidden w-full mt-6 px-6 py-3 text-lg font-bold text-white bg-blue-500 hover:bg-blue-600 rounded-lg shadow-md transition duration-200 transform hover:scale-105"
        >
            Jogar Novamente
        </button>

        <p id="error-message" class="text-lose text-center mt-3 hidden font-medium">
            Por favor, insira um n√∫mero v√°lido entre 1 e 100.
        </p>
    </div>

    <div class="w-full max-w-xs sm:max-w-sm bg-primary-bg p-6 rounded-xl shadow-2xl border border-gray-700 order-1 sm:order-2">
        <h2 class="text-2xl font-bold text-white mb-1 text-center">üèÜ Placar Global</h2>
        <p id="currentUserId" class="text-xs text-gray-500 text-center mb-4 truncate">
            Status: Conectando...
        </p> 
        
        <div id="leaderboardContainer" class="space-y-2">
            <div id="loadingMessage" class="text-gray-400 text-center">Carregando placar...</div>
            
            </div>
    </div>


    <div id="scoreModal" class="hidden modal-overlay fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-primary-bg p-8 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-100">
            <h2 class="text-3xl font-bold text-win mb-4 text-center">Novo Recorde! üéâ</h2>
            <p id="modalMessage" class="text-gray-300 mb-6 text-center">Voc√™ conseguiu em X tentativas. Insira seu nickname para salvar seu feito no Placar Global!</p>
            
            <input 
                type="text" 
                id="nicknameInput" 
                placeholder="Seu Nickname" 
                maxlength="12"
                class="w-full p-3 text-lg rounded-lg border-2 border-accent bg-gray-700 text-white placeholder-gray-400 mb-4 transition duration-200"
            >
            
            <button 
                id="saveScoreButton" 
                class="w-full px-6 py-3 text-lg font-bold text-primary-bg bg-accent hover:bg-win rounded-lg shadow-md transition duration-200 transform hover:scale-105"
            >
                Salvar Recorde!
            </button>
            <button 
                id="closeModalButton" 
                class="w-full mt-3 px-6 py-3 text-sm font-bold text-gray-400 hover:text-white transition duration-200"
            >
                Jogar Novamente (N√£o salvar)
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configura√ß√µes e Vari√°veis Globais
        setLogLevel('Debug');
        
        // --- 1. CONFIGURA√á√ÉO FIREBASE PARA AMBIENTES EXTERNOS (GIT/LOCAL) ---
        // Para habilitar o Placar Global, voc√™ DEVE
        // substituir a vari√°vel 'localFirebaseConfig' abaixo pela configura√ß√£o do SEU projeto Firebase.
        
        const localFirebaseConfig = {
             // apiKey: "SEU_API_KEY",
             // authDomain: "SEU_AUTH_DOMAIN",
             // projectId: "SEU_PROJECT_ID",
             // storageBucket: "SEU_STORAGE_BUCKET",
             // messagingSenderId: "SEU_MESSAGING_SENDER_ID",
             // appId: "SEU_APP_ID"
        };
        
        // As vari√°veis __app_id, __firebase_config e __initial_auth_token s√£o usadas em um ambiente
        // espec√≠fico (Canvas). Se voc√™ estiver rodando localmente, elas ser√£o ignoradas.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig = {};
        try {
             firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
             console.error("Erro ao fazer parse da configura√ß√£o do Firebase. Usando configura√ß√£o local.");
        }
        
        // Se a configura√ß√£o do Canvas falhar ou estiver vazia, tentamos usar a configura√ß√£o local
        if (Object.keys(firebaseConfig).length === 0 && Object.keys(localFirebaseConfig).length > 0) {
             firebaseConfig = localFirebaseConfig;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- FIM DA CONFIGURA√á√ÉO FIREBASE ---

        let db;
        let auth;
        let userId;

        // Vari√°veis globais do jogo
        let secretNumber;
        let attempts;
        const maxAttempts = 10;
        
        // Refer√™ncias aos elementos do DOM
        const guessInput = document.getElementById('guessInput');
        const checkButton = document.getElementById('checkButton');
        const resetButton = document.getElementById('resetButton');
        const messageDisplay = document.getElementById('message');
        const attemptsDisplay = document.getElementById('attempts');
        const errorDisplay = document.getElementById('error-message');
        const inputArea = document.getElementById('input-area');
        
        // Elementos do Placar e Modal
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const scoreModal = document.getElementById('scoreModal');
        const modalMessage = document.getElementById('modalMessage');
        const nicknameInput = document.getElementById('nicknameInput');
        const saveScoreButton = document.getElementById('saveScoreButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const currentUserIdDisplay = document.getElementById('currentUserId');


        /**
         * Inicializa o Firebase (Auth e Firestore).
         */
        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    console.error("Configura√ß√£o do Firebase n√£o est√° completa. O Placar Global est√° DESATIVADO.");
                    leaderboardContainer.innerHTML = `<p class="text-lose text-center">Placar DESATIVADO: Configure seu Firebase para uso local.</p>`;
                    currentUserIdDisplay.textContent = "Status: Placar Desativado.";
                    currentUserIdDisplay.classList.remove('text-gray-500', 'text-accent');
                    currentUserIdDisplay.classList.add('text-lose');
                    
                    // Fallback para userId mesmo sem configura√ß√£o completa para l√≥gica do jogo
                    try {
                        const app = initializeApp({}); 
                        auth = getAuth(app);
                        await signInAnonymously(auth);
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                    } catch {
                        userId = crypto.randomUUID();
                    }
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autentica√ß√£o: Tenta com token customizado ou anonimamente
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // Atualiza o status de conex√£o
                currentUserIdDisplay.textContent = `Seu ID: ${userId}`;
                currentUserIdDisplay.classList.remove('text-gray-500', 'text-lose');
                currentUserIdDisplay.classList.add('text-accent');

                console.log("Firebase e autentica√ß√£o inicializados. User ID:", userId);
                
                // Inicia o listener do placar ap√≥s a autentica√ß√£o
                loadLeaderboard();
                
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                leaderboardContainer.innerHTML = `<p class="text-lose text-center">Erro ao conectar com o Placar.</p>`;
                currentUserIdDisplay.textContent = "Erro de conex√£o Firebase.";
                currentUserIdDisplay.classList.remove('text-gray-500', 'text-accent');
                currentUserIdDisplay.classList.add('text-lose');
            }
        }
        
        /**
         * Gera o caminho da cole√ß√£o para o Placar Global.
         */
        function getLeaderboardCollectionRef() {
            // O placar √© p√∫blico para todos os usu√°rios do app
            return collection(db, `artifacts/${appId}/public/data/scores`);
        }

        /**
         * Renderiza o placar a partir de um snapshot do Firestore.
         */
        function renderLeaderboard(scores) {
            loadingMessage.classList.add('hidden');
            
            if (scores.length === 0) {
                leaderboardContainer.innerHTML = `<p class="text-gray-400 text-center mt-4">Nenhum recorde ainda. Seja o primeiro!</p>`;
                return;
            }

            leaderboardContainer.innerHTML = scores.map((score, index) => {
                const rank = index + 1;
                let rankClass = 'bg-gray-500'; // Cor padr√£o para os demais
                
                // Define a cor de acordo com o ranking (coroas)
                if (rank === 1) {
                    rankClass = 'bg-yellow-500'; // Ouro
                } else if (rank === 2) {
                    rankClass = 'bg-gray-400';  // Prata
                } else if (rank === 3) {
                    rankClass = 'bg-amber-700';  // Bronze
                }
                
                // Aplica as classes de cor diretamente ao elemento do rank
                return `
                    <div class="score-item flex justify-between items-center p-3 rounded-lg bg-gray-700 shadow-md">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold text-white mr-2 ${rankClass}">
                            ${rank}
                        </span>
                        <span class="flex-grow text-white font-medium truncate">${score.nickname}</span>
                        <span class="text-accent font-bold">${score.attempts} tentativas</span>
                    </div>
                `;
            }).join('');
        }

        /**
         * Carrega o placar em tempo real usando onSnapshot.
         */
        function loadLeaderboard() {
            if (!db) return;

            // Ordena por 'attempts' (tentativas) de forma ascendente e limita aos 10 melhores
            const scoresQuery = query(
                getLeaderboardCollectionRef(),
                orderBy('attempts', 'asc'),
                orderBy('timestamp', 'asc'), // Crit√©rio de desempate
                limit(10)
            );

            // Listener em tempo real
            onSnapshot(scoresQuery, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                renderLeaderboard(scores);
            }, (error) => {
                console.error("Erro ao carregar placar:", error);
                leaderboardContainer.innerHTML = `<p class="text-lose text-center">Falha ao carregar placar.</p>`;
            });
        }

        /**
         * Mostra o modal de recorde ap√≥s a vit√≥ria.
         */
        function showScoreModal(attempts) {
            if (!db) {
                // Se o Firebase n√£o estiver inicializado (erro local), pula o salvamento do score.
                alert(`üéâ Parab√©ns! Voc√™ adivinhou em ${attempts} tentativas! O Placar Global est√° desativado.`);
                initGame();
                return;
            }
            
            modalMessage.textContent = `Voc√™ adivinhou em ${attempts} tentativas! Insira seu nickname (m√°x. 12 caracteres) para salvar seu feito no Placar Global!`;
            nicknameInput.value = '';
            scoreModal.classList.remove('hidden');
        }

        /**
         * Esconde o modal de recorde.
         */
        function hideScoreModal() {
            scoreModal.classList.add('hidden');
        }

        /**
         * Salva a pontua√ß√£o no Firestore.
         */
        async function saveScore() {
            const nickname = nicknameInput.value.trim().substring(0, 12);

            if (!nickname || nickname.length < 2) {
                alert("Por favor, insira um nickname com pelo menos 2 caracteres."); 
                return;
            }
            
            if (!db || !userId) {
                console.error("Database ou User ID n√£o est√£o dispon√≠veis. N√£o √© poss√≠vel salvar score.");
                alert("Erro: O Placar Global n√£o est√° ativo (sem conex√£o com o banco de dados).");
                return;
            }
            
            saveScoreButton.disabled = true;
            saveScoreButton.textContent = "Salvando...";

            try {
                // Adiciona o novo recorde
                await addDoc(getLeaderboardCollectionRef(), {
                    nickname: nickname,
                    attempts: attempts,
                    timestamp: Date.now(),
                    recordedBy: userId 
                });

                hideScoreModal();
                alert(`Recorde de ${nickname} salvo com ${attempts} tentativas!`); 
                initGame(); // Inicia um novo jogo
            } catch (e) {
                console.error("Erro ao adicionar recorde:", e);
                alert("Erro ao salvar recorde. Tente novamente.");
            } finally {
                saveScoreButton.disabled = false;
                saveScoreButton.textContent = "Salvar Recorde!";
            }
        }


        // --- L√≥gica do Jogo ---

        /**
         * Gera um n√∫mero aleat√≥rio entre 1 e 100 e reinicia o estado do jogo.
         */
        function initGame() {
            secretNumber = Math.floor(Math.random() * 100) + 1;
            attempts = 0;
            
            // Atualiza a UI
            attemptsDisplay.textContent = attempts;
            messageDisplay.textContent = "Digite um n√∫mero e clique em Verificar!";
            messageDisplay.classList.remove('bg-win', 'bg-lose', 'text-white');
            messageDisplay.classList.add('bg-gray-700', 'text-gray-300');
            
            guessInput.value = '';
            guessInput.disabled = false;
            checkButton.disabled = false;
            resetButton.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            inputArea.classList.remove('hidden');

            console.log("Novo n√∫mero secreto gerado: " + secretNumber);
        }

        /**
         * Valida o palpite do usu√°rio.
         */
        function validateGuess(guess) {
            if (isNaN(guess) || guess < 1 || guess > 100) {
                errorDisplay.classList.remove('hidden');
                messageDisplay.textContent = "Palpite inv√°lido!";
                return false;
            }
            errorDisplay.classList.add('hidden');
            return true;
        }

        /**
         * Fun√ß√£o de fim de jogo (Vit√≥ria ou Derrota).
         */
        function gameOver(isWin, feedbackMessage, newBgClass, newTextColor) {
            messageDisplay.innerHTML = feedbackMessage;
            messageDisplay.classList.remove('bg-gray-700', 'bg-win', 'bg-lose', 'text-gray-300', 'text-white');
            messageDisplay.classList.add(newBgClass, newTextColor);

            guessInput.disabled = true;
            checkButton.disabled = true;
            resetButton.classList.remove('hidden');
            inputArea.classList.add('hidden');

            if (isWin) {
                showScoreModal(attempts);
            }
        }

        /**
         * Verifica o palpite do jogador e atualiza o estado do jogo.
         */
        function checkGuess() {
            const guess = parseInt(guessInput.value);

            if (!validateGuess(guess)) {
                return;
            }

            attempts++;
            attemptsDisplay.textContent = attempts;

            let feedbackMessage = "";

            if (guess === secretNumber) {
                feedbackMessage = `üéâ Parab√©ns! Voc√™ adivinhou o n√∫mero ${secretNumber} em ${attempts} tentativas!`;
                gameOver(true, feedbackMessage, 'bg-win', 'text-white');
                return;
            } else if (attempts >= maxAttempts) {
                feedbackMessage = `üò¢ Fim de jogo! Voc√™ n√£o conseguiu adivinhar. O n√∫mero era ${secretNumber}.`;
                gameOver(false, feedbackMessage, 'bg-lose', 'text-white');
                return;
            } else if (guess < secretNumber) {
                feedbackMessage = `Seu palpite (${guess}) est√° **MUITO BAIXO**. Tente um n√∫mero maior.`;
            } else { // guess > secretNumber
                feedbackMessage = `Seu palpite (${guess}) est√° **MUITO ALTO**. Tente um n√∫mero menor.`;
            }

            // Atualiza o display da mensagem
            messageDisplay.innerHTML = feedbackMessage;
            messageDisplay.classList.remove('bg-win', 'bg-lose', 'text-white');
            messageDisplay.classList.add('bg-gray-700', 'text-gray-300');
            
            guessInput.value = '';
            guessInput.focus();
        }

        // --- Configura√ß√£o dos Eventos ---
        checkButton.addEventListener('click', checkGuess);

        guessInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault(); 
                checkGuess();
            }
        });

        resetButton.addEventListener('click', initGame);

        // Eventos do Modal
        saveScoreButton.addEventListener('click', saveScore);
        closeModalButton.addEventListener('click', () => {
            hideScoreModal();
            initGame(); // Inicia um novo jogo sem salvar
        });

        // Inicia o Firebase e o Jogo
        window.onload = () => {
            initFirebase();
            initGame();
        };
    </script>
</body>
</html>
